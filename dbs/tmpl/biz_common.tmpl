// hey-template version: {{{.TemplateVersion}}}

package biz

import (
	"fmt"
	"github.com/cd365/hey"
	"{{{.ModuleImportPrefix}}}data"
    "{{{.ModuleImportPrefix}}}model"
)

type Common struct {
	db  *data.Tables
	way hey.WayWriterReader
}

// NewCommon common 通用操作
func NewCommon(
	db *data.Tables,
	way hey.WayWriterReader,
) *Common {
	return &Common{
		db:  db,
		way: way,
	}
}

func (s *Common) F(filter ...hey.Filter) hey.Filter {
	return s.way.R().F(filter...)
}

// AddMod 保存一条或者多条数据(filter:单个字段作为条件过滤; addMod: map[string]interface{}:指定字段更新, 结构体:所有字段更新)
func (s *Common) AddMod(table model.Table, field string, values interface{}, addMod interface{}, way ...*hey.Way) (int64, error) {
	if values == nil {
		return table.Insert(addMod, way...) // 1 直接插入(单条|多条)
	}
	fvs := hey.SliceAny121(values)
	filter := table.F().In(field, fvs...)
	if tmp, ok := addMod.(map[string]interface{}); ok {
		return table.Update(filter, tmp, way...) // 2 直接更新(单条|多条)
	}
	// 单条记录
	if len(fvs) > 1 {
		return 0, fmt.Errorf("update or insert: mismatched data types")
	}
	had, err := table.SelectGetOne(func(get *hey.Get) { get.Where(filter) })
	if err != nil {
		return 0, err
	}
	if had == nil {
		return table.Insert(addMod, way...) // 单条插入
	}
	return table.Update(filter, addMod, way...) // 单条更新
}

// Remove 删除一条或者多条数据
func (s *Common) Remove(table model.Table, field string, values interface{}, way ...*hey.Way) (int64, error) {
	return table.Delete(table.F().In(field, values), way...)
}
{{{.MethodsContent}}}